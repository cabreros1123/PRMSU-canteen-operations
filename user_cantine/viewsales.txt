<?php
session_start(); // Start the session
include 'db.php';

// Check if the user is logged in and the session variable is set
if (!isset($_SESSION['id_cantine'])) {
    die('Error: You are not authorized to view this page. Please log in.');
}

// Get the id_cantine of the logged-in user
$id_cantine = $_SESSION['id_cantine'];

// Fetch sales data for the logged-in user's canteen, including the saledate column
$query = "SELECT id, total_product, product_cost, product_sale, total_profit, products, saledate 
          FROM sales 
          WHERE id_cantine = ? AND del_status = 0";
$stmt = $conn->prepare($query);
$stmt->bind_param('i', $id_cantine);
$stmt->execute();
$result = $stmt->get_result();
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Sales</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table th, table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        table th {
            background-color: #f2f2f2;
        }

        .btn {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-edit {
            background-color: #4CAF50;
            color: white;
        }

        .btn-delete {
            background-color: #f44336;
            color: white;
        }

        .btn-add {
            background-color: #2196F3;
            color: white;
            margin-bottom: 10px;
            display: inline-block;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 5px;
        }
    </style>
</head>
<body>
<?php require_once "header.php"; ?>
    <div class="container">
        <h1>View Audit Sales Reports</h1>
        <a href="create-sale.php" class="btn-add">Add New Sale</a>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div></div> <!-- Empty div for alignment -->
            <input type="text" id="searchInput" placeholder="Search sales..." style="padding: 5px; width: 300px; border: 1px solid #ddd; border-radius: 5px;">
        </div>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Total Products</th>
                    <th>Product Cost</th>
                    <th>Product Sales</th>
                    <th>Total Profit</th>
                    <th>Date</th> <!-- Added Date column -->
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <?php while ($row = $result->fetch_assoc()) : ?>
                    <tr>
                        <td><?php echo $row['id']; ?></td>
                        <td><?php echo $row['total_product']; ?></td>
                        <td>₱<?php echo number_format($row['product_cost'], 2); ?></td>
                        <td>₱<?php echo number_format($row['product_sale'], 2); ?></td>
                        <td>₱<?php echo number_format($row['total_profit'], 2); ?></td>
                        <td><?php echo date('Y-m-d', strtotime($row['saledate'])); ?></td> <!-- Display the date -->
                        <td>
                            <a href="create-sale.php?edit_id=<?php echo $row['id']; ?>" class="btn btn-edit">Edit</a>
                            <button class="btn btn-print" onclick="printReport(<?php echo $row['id']; ?>)">Print</button>
                            <button class="btn btn-delete" onclick="deleteSale(<?php echo $row['id']; ?>)">Delete</button>
                        </td>
                    </tr>
                <?php endwhile; ?>
            </tbody>
        </table>
        <div id="paginationControls" style="margin-top: 10px; text-align: center;">
            <button id="prevPage" onclick="prevPage()" style="padding: 5px 10px; margin-right: 5px;">Previous</button>
            <span id="pageInfo"></span>
            <button id="nextPage" onclick="nextPage()" style="padding: 5px 10px; margin-left: 5px;">Next</button>
        </div>
    </div>

    <script>
         let currentPage = 1;
        const rowsPerPage = 10;

        function showPage(page) {
            const rows = document.querySelectorAll('table tbody tr');
            const totalRows = rows.length;
            const totalPages = Math.ceil(totalRows / rowsPerPage);

            // Ensure the page number is within bounds
            if (page < 1) page = 1;
            if (page > totalPages) page = totalPages;

            // Hide all rows
            rows.forEach((row, index) => {
                row.style.display = 'none';
            });

            // Show only the rows for the current page
            const start = (page - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            for (let i = start; i < end && i < totalRows; i++) {
                    if (!rows[i].classList.contains('hidden')) {
                    rows[i].style.display = '';
                }
            }

            // Update the page info
            document.getElementById('pageInfo').textContent = `Page ${page} of ${totalPages}`;

            // Enable or disable buttons based on the current page
            document.getElementById('prevPage').disabled = page === 1;
            document.getElementById('nextPage').disabled = page === totalPages;

            currentPage = page;
        }

        function nextPage() {
            showPage(currentPage + 1);
        }

        function prevPage() {
            showPage(currentPage - 1);
        }

        function searchTable() {
            const filter = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('table tbody tr');

            rows.forEach(row => {
                const id = row.cells[0].textContent.toLowerCase();
                const cantineName = row.cells[1].textContent.toLowerCase();
                const totalProduct = row.cells[2].textContent.toLowerCase();
                const saleDate = row.cells[6].textContent.toLowerCase();

                if (id.includes(filter) || cantineName.includes(filter) || totalProduct.includes(filter) || saleDate.includes(filter)) {
                    row.classList.remove('hidden');
                } else {
                    row.classList.add('hidden');
                }
            });

            // Reset pagination to the first page after search
            showPage(1);
        }

        // Attach event listener to the search input
        document.getElementById('searchInput').addEventListener('input', searchTable);

        // Initialize the table with the first page
        document.addEventListener('DOMContentLoaded', () => {
            showPage(1);
        });

        function deleteSale(id) {
            if (confirm('Are you sure you want to delete this sale?')) {
                fetch('delete_sale.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id: id })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Sale deleted successfully!');
                        location.reload();
                    } else {
                        alert('Failed to delete sale: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the sale.');
                });
            }
        }
        function printReport(saleId) {
            // Fetch the sale data from the server
            fetch(`fetch_sale.php?id=${saleId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const sale = data.sale;
                        const products = JSON.parse(sale.products);
                        const canteenName = sale.cantine_name; // Fetch the canteen name

                        // Create a hidden div for the printable content
                        const printDiv = document.createElement('div');
                        printDiv.style.display = 'none'; // Hide the div from the main page
                        printDiv.innerHTML = `
                            <html>
                                <head>
                                    <title>Sale Report</title>
                                    <style>
                                        body {
                                            font-family: Arial, sans-serif;
                                            margin: 20px;
                                            text-align: center;
                                            position: relative;
                                        }
                                        .logo {
                                            position: absolute;
                                            top: 0px;
                                            left: 20px;
                                            width: 80px;
                                            height: 80px;
                                        }
                                        h1 {
                                            margin: 0;
                                            font-size: 24px;
                                        }
                                        h2 {
                                            margin: 5px 0 20px;
                                            font-size: 16px;
                                            font-weight: normal;
                                            color: gray;
                                        }
                                        table {
                                            width: 100%;
                                            border-collapse: collapse;
                                            margin-top: 20px;
                                        }
                                        table th, table td {
                                            border: 1px solid #ddd;
                                            padding: 8px;
                                            text-align: center;
                                        }
                                        table th {
                                            background-color: #f2f2f2;
                                        }
                                        .total {
                                            font-weight: bold;
                                        }
                                    </style>
                                </head>
                                <body>
                                    <img src="img/prmsu_logo.png" alt="Logo" class="logo">
                                    <h1>${canteenName}</h1>
                                    <h2>Sales Report</h2>
                                    <p><strong>Date:</strong> ${sale.saledate}</p>
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Description</th>
                                                <th>Quantity</th>
                                                <th>Cost</th>
                                                <th>Sell</th>
                                                <th>Profit</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${products.map(product => `
                                                <tr>
                                                    <td>${product.id}</td>
                                                    <td>${product.description}</td>
                                                    <td>${product.quantity}</td>
                                                    <td>₱${product.cost.toFixed(2)}</td>
                                                    <td>₱${product.sell.toFixed(2)}</td>
                                                    <td>₱${product.profit.toFixed(2)}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                        <tfoot>
                                            <tr class="total">
                                                <td colspan="3">Totals</td>
                                                <td>₱${products.reduce((sum, p) => sum + p.cost, 0).toFixed(2)}</td>
                                                <td>₱${products.reduce((sum, p) => sum + p.sell, 0).toFixed(2)}</td>
                                                <td>₱${products.reduce((sum, p) => sum + p.profit, 0).toFixed(2)}</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </body>
                            </html>
                        `;

                        // Append the div to the body
                        document.body.appendChild(printDiv);

                        // Print the content of the div
                        const originalContent = document.body.innerHTML;
                        document.body.innerHTML = printDiv.innerHTML;
                        window.print();

                        // Restore the original content
                        document.body.innerHTML = originalContent;
                        location.reload(); // Reload the page to restore event listeners
                    } else {
                        alert('Failed to fetch sale data: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while fetching the sale data.');
                });
        }
    </script>
</body>
</html>